<!DOCTYPE html>
<html lang="{{ site.lang | default: 'en' }}">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="author" content="Orpheus">
  
  {% assign albums = site.albums | sort: 'date' | reverse %}
  {% assign latest_album = albums | first %}

  {% if page.layout == 'home' %}
    {% assign page_title = site.title | append: " â€” " | append: site.description %}
    {% if latest_album %}
      {% assign page_description = site.description | append: " Featured: " | append: latest_album.title %}
    {% else %}
      {% assign page_description = site.description %}
    {% endif %}
  {% else %}
    {% assign page_title = page.title | append: " | " | append: site.title %}
    {% assign page_description = page.description | markdownify | default: page.excerpt | default: site.description | strip_html | strip_newlines | escape | truncate: 160 %}
  {% endif %}

  <title>{{ page_title }}</title>
  <meta name="description" content="{{ page_description }}">
  
  {% assign default_image = "/assets/images/og-image.png" | absolute_url %}
  {% if page.og_image %}
    {% if page.og_image contains "://" %}
      {% assign og_image = page.og_image %}
    {% else %}
      {% assign og_image = page.og_image | absolute_url %}
    {% endif %}
  {% elsif page.image %}
    {% if page.image contains "://" %}
      {% assign og_image = page.image %}
    {% else %}
      {% assign og_image = page.image | absolute_url %}
    {% endif %}
  {% elsif page.poster_url %}
    {% assign og_image = page.poster_url | absolute_url %}
  {% else %}
    {% assign og_image = default_image %}
  {% endif %}

  <!-- Open Graph / Facebook / LinkedIn -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="{{ page.url | absolute_url }}">
  <meta property="og:site_name" content="{{ site.title }}">
  <meta property="og:title" content="{{ page_title }}">
  <meta property="og:description" content="{{ page_description }}">
  <meta property="og:image" content="{{ og_image }}">
  <meta property="og:image:alt" content="{{ page.title | default: site.title }}">

  {% if page.layout == 'post' %}
    <meta property="article:published_time" content="{{ page.date | date_to_xmlschema }}">
  {% endif %}

  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:url" content="{{ page.url | absolute_url }}">
  <meta property="twitter:title" content="{{ page_title }}">
  <meta property="twitter:description" content="{{ page_description }}">
  <meta property="twitter:image" content="{{ og_image }}">

  {% if page.layout == 'album' %}
    <meta property="article:published_time" content="{{ page.date | date_to_xmlschema }}">
    {% for tag in page.tags %}
      <meta property="article:tag" content="{{ tag }}">
    {% endfor %}
  {% endif %}

  <!-- Theme color for mobile browsers and PWA splash screen -->
  <meta name="theme-color" content="#0d0d0d">
  <meta name="msapplication-navbutton-color" content="#0d0d0d">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <!-- Web App Manifest -->
  <link rel="manifest" href="{{ '/manifest.json' | relative_url }}">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Outfit:wght@500;700&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="{{ '/assets/css/main.css' | relative_url }}">
  <link rel="icon" type="image/png" sizes="192x192" href="{{ '/assets/images/favicon-192.png' | relative_url }}">
  <link rel="icon" type="image/png" sizes="512x512" href="{{ '/assets/images/favicon-512.png' | relative_url }}">
  <link rel="apple-touch-icon" href="{{ '/assets/images/favicon-512.png' | relative_url }}">
  <style>
    @view-transition {
      navigation: auto;
    }
  </style>
</head>

<body class="layout-{{ page.layout }}">
  <header>
    <div class="container">
      <nav>
        <a href="{{ '/' | relative_url }}" class="logo">{{ site.title }}</a>
        <button class="nav-toggle" id="navToggle" aria-label="Toggle navigation" aria-expanded="false">
          <span class="hamburger-line"></span>
          <span class="hamburger-line"></span>
          <span class="hamburger-line"></span>
        </button>
        <ul class="nav-links" id="navLinks">
          {% for item in site.navigation %}
          {% if item.expandable %}
          <li class="nav-expandable">
            <button class="nav-expand-btn" aria-expanded="false">
              {{ item.title }}
              <svg class="nav-chevron" xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24"
                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="6 9 12 15 18 9"></polyline>
              </svg>
            </button>
            <ul class="nav-dropdown">
              {% if item.children == 'posts' %}
              {% for post in site.posts %}
              <li><a href="{{ post.url | relative_url }}"><span class="nav-post-title">{{ post.title }}</span><span
                    class="nav-post-date">{{ post.date | date: "%b %-d, %Y" }}</span></a></li>
              {% endfor %}
              {% elsif item.children == 'albums' %}
              {% assign nav_albums = site.albums | sort: "date" | reverse %}
              {% for track in nav_albums %}
              <li><a href="{{ track.url | relative_url }}"><span class="nav-post-title">{{ track.title }}</span><span
                    class="nav-post-date">{{ track.date | date: "%b %-d, %Y" }}</span></a></li>
              {% endfor %}
              {% elsif item.children %}
              {% for child in item.children %}
              <li><a href="{{ child.url | relative_url }}">{{ child.title }}</a></li>
              {% endfor %}
              {% endif %}
            </ul>
          </li>
          {% else %}
          <li><a href="{{ item.url | relative_url }}">{{ item.title }}</a></li>
          {% endif %}
          {% endfor %}
        </ul>
      </nav>
    </div>
  </header>

  <main class="container">
    {{ content }}
  </main>

  <footer>
    <div class="container">
      <p>&copy; {{ site.time | date: '%Y' }} {{ site.title }}. All rights reserved.</p>
      <p>
        {% if site.social.github %}
        <a href="https://github.com/{{ site.social.github }}">GitHub</a>
        {% endif %}
      </p>
    </div>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const navToggle = document.getElementById('navToggle');
      const navLinks = document.getElementById('navLinks');

      if (navToggle && navLinks) {
        navToggle.addEventListener('click', () => {
          const isOpen = navToggle.classList.toggle('open');
          navLinks.classList.toggle('open');
          navToggle.setAttribute('aria-expanded', isOpen);

          // Haptic feedback
          if (navigator.vibrate) {
            navigator.vibrate(isOpen ? [30, 50, 20] : [20]);
          }
        });

        // Close menu when clicking a link
        navLinks.querySelectorAll('a').forEach(link => {
          link.addEventListener('click', () => {
            navToggle.classList.remove('open');
            navLinks.classList.remove('open');
            navToggle.setAttribute('aria-expanded', 'false');
          });
        });

        // Handle expandable nav items
        document.querySelectorAll('.nav-expand-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const expanded = btn.getAttribute('aria-expanded') === 'true';
            btn.setAttribute('aria-expanded', !expanded);
            btn.parentElement.classList.toggle('expanded');

            // Haptic feedback
            if (navigator.vibrate) {
              navigator.vibrate(expanded ? [20] : [30, 50, 20]);
            }
          });
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
          if (!e.target.closest('.nav-expandable')) {
            document.querySelectorAll('.nav-expandable.expanded').forEach(item => {
              item.classList.remove('expanded');
              item.querySelector('.nav-expand-btn').setAttribute('aria-expanded', 'false');
            });
          }
        });
      }

      // Auto-hide main nav on scroll (always runs, independent of mobile nav)
      const mainHeader = document.querySelector('header');
      if (mainHeader) {
        let lastScrollY = 0;
        let navTicking = false;

        window.addEventListener('scroll', () => {
          if (!navTicking) {
            window.requestAnimationFrame(() => {
              const currentScrollY = window.pageYOffset;

              if (currentScrollY <= 10) {
                // Always show near top
                mainHeader.classList.remove('nav-hidden');
              } else if (currentScrollY > lastScrollY) {
                // Scrolling down - hide nav
                mainHeader.classList.add('nav-hidden');
              } else {
                // Scrolling up - show nav
                mainHeader.classList.remove('nav-hidden');
              }

              lastScrollY = currentScrollY;
              navTicking = false;
            });
            navTicking = true;
          }
        });
      }

      // Collapse album description on scroll
      const collapseTargets = document.querySelectorAll('.album-description, .album-body-text, .album-meta, .album-meta-top');
      if (collapseTargets.length > 0) {
        let targetData = [];

        const updateTargetData = () => {
          targetData = Array.from(collapseTargets).map(el => {
            const style = window.getComputedStyle(el);
            // Temporarily remove our inline styles to measure original values
            const oldMaxHeight = el.style.maxHeight;
            const oldOpacity = el.style.opacity;
            const oldMT = el.style.marginTop;
            const oldMB = el.style.marginBottom;
            const oldTrans = el.style.transform;

            el.style.maxHeight = 'none';
            el.style.opacity = '';
            el.style.marginTop = '';
            el.style.marginBottom = '';
            el.style.transform = '';

            const data = {
              el: el,
              marginTop: parseFloat(style.marginTop) || 0,
              marginBottom: parseFloat(style.marginBottom) || 0,
              originalOpacity: parseFloat(style.opacity) || 1,
              maxHeight: el.scrollHeight
            };

            // Restore
            el.style.maxHeight = oldMaxHeight;
            el.style.opacity = oldOpacity;
            el.style.marginTop = oldMT;
            el.style.marginBottom = oldMB;
            el.style.transform = oldTrans;

            // Set static animation properties
            el.style.transformOrigin = 'top center';
            el.style.overflow = 'hidden';

            return data;
          });
        };

        let currentScrollY = window.pageYOffset;
        let targetScrollY = window.pageYOffset;
        let ticking = false;

        const updateAnimation = () => {
          // Smoothly interpolate scroll value (lerp)
          currentScrollY += (targetScrollY - currentScrollY) * 0.15;
          
          const threshold = 200;
          const rawFraction = Math.max(0, 1 - currentScrollY / threshold);
          // Smoothstep easing for more natural velocity
          const fraction = rawFraction * rawFraction * (3 - 2 * rawFraction);

          targetData.forEach(data => {
            data.el.style.opacity = (fraction * data.originalOpacity).toFixed(3);
            data.el.style.maxHeight = (fraction * data.maxHeight).toFixed(1) + 'px';
            data.el.style.marginTop = (fraction * data.marginTop).toFixed(1) + 'px';
            data.el.style.marginBottom = (fraction * data.marginBottom).toFixed(1) + 'px';
            data.el.style.pointerEvents = fraction < 0.1 ? 'none' : 'auto';
            data.el.style.transform = `scale(${ (0.98 + (fraction * 0.02)).toFixed(3) })`;
          });

          if (Math.abs(targetScrollY - currentScrollY) > 0.1) {
            window.requestAnimationFrame(updateAnimation);
          } else {
            ticking = false;
          }
        };

        const handleDescScroll = (instant = false) => {
          targetScrollY = window.pageYOffset;
          if (instant) currentScrollY = targetScrollY;
          if (!ticking) {
            ticking = true;
            window.requestAnimationFrame(updateAnimation);
          }
        };

        updateTargetData();

        window.addEventListener('scroll', () => handleDescScroll());

        window.addEventListener('resize', () => {
          updateTargetData();
          handleDescScroll(true);
        });

        window.addEventListener('load', () => {
          updateTargetData();
          handleDescScroll(true);
        });

        // Initial state
        handleDescScroll(true);
      }

      // Image and Video Lightbox for blog posts and home page
      const contentContainer = document.querySelector('.post-content') || document.querySelector('.home') || document.querySelector('.album-collection') || document.querySelector('.album-detail');
      if (contentContainer) {
        // Create lightbox elements with video support
        const lightbox = document.createElement('div');
        lightbox.className = 'image-lightbox';
        lightbox.innerHTML = `
          <span class="lightbox-close">&times;</span>
          <img src="" alt="" class="lightbox-media">
          <video class="lightbox-media lightbox-video" controls style="display: none;"></video>
        `;
        document.body.appendChild(lightbox);

        const lightboxImg = lightbox.querySelector('img');
        const lightboxVideo = lightbox.querySelector('video');
        const lightboxClose = lightbox.querySelector('.lightbox-close');

        // Track if we pushed a history state for the lightbox
        let lightboxHistoryPushed = false;
        let currentSourceVideo = null;

        // Open lightbox for image
        const openImageLightbox = (src, alt) => {
          lightboxImg.src = src;
          lightboxImg.alt = alt;
          lightboxImg.style.display = 'block';
          lightboxVideo.style.display = 'none';
          lightboxVideo.pause();
          lightbox.classList.add('active');
          document.body.style.overflow = 'hidden';

          if (!lightboxHistoryPushed) {
            history.pushState({ lightbox: true }, '');
            lightboxHistoryPushed = true;
          }
        };

        // Open lightbox for video
        const openVideoLightbox = (src, sourceVideo) => {
          if (sourceVideo) {
            if (currentSourceVideo && currentSourceVideo !== sourceVideo) {
              currentSourceVideo.pause();
            }
            currentSourceVideo = sourceVideo;
            currentSourceVideo.pause();
          }

          lightboxVideo.src = src;
          lightboxVideo.style.display = 'block';
          lightboxImg.style.display = 'none';
          lightbox.classList.add('active');
          document.body.style.overflow = 'hidden';

          if (sourceVideo) {
            lightboxVideo.currentTime = sourceVideo.currentTime;
            lightboxVideo.volume = sourceVideo.volume;
            lightboxVideo.muted = sourceVideo.muted;
          }
          
          // Try to play with error handling for browser blocks
          const playPromise = lightboxVideo.play();
          if (playPromise !== undefined) {
            playPromise.catch(error => {
              console.log("Auto-play was prevented. Muting and showing controls.");
              lightboxVideo.muted = true;
              lightboxVideo.controls = true;
              lightboxVideo.play();
            });
          }

          if (!lightboxHistoryPushed) {
            history.pushState({ lightbox: true }, '');
            lightboxHistoryPushed = true;
          }
        };

        // Close lightbox handlers
        const closeLightbox = (fromPopState = false) => {
          if (!lightbox.classList.contains('active')) return;

          lightbox.classList.remove('active');
          document.body.style.overflow = '';
          
          lightboxVideo.pause();
          if (currentSourceVideo) {
            currentSourceVideo.currentTime = lightboxVideo.currentTime;
            currentSourceVideo.play().catch(e => console.log("Error resuming video", e));
            currentSourceVideo = null;
          }
          lightboxVideo.src = '';

          if (!fromPopState && lightboxHistoryPushed) {
            lightboxHistoryPushed = false;
            history.back();
          } else {
            lightboxHistoryPushed = false;
          }
        };

        // Handle browser back button
        window.addEventListener('popstate', (e) => {
          if (lightbox.classList.contains('active')) {
            closeLightbox(true);
          }
        });

        // Add click handlers to all images in post content (including table images)
        contentContainer.querySelectorAll('img').forEach(img => {
          img.style.cursor = 'zoom-in';
          img.addEventListener('click', () => {
            openImageLightbox(img.src, img.alt);
          });
        });

        // Add click handlers to videos with .video-lightbox-trigger class
        contentContainer.querySelectorAll('video.video-lightbox-trigger').forEach(video => {
          const container = video.closest('.video-container') || video.closest('.grid-video-container');
          const expandOverlay = container ? container.querySelector('.expand-overlay') : null;
          
          // If there's an expand overlay, only trigger lightbox from the overlay
          if (expandOverlay) {
            expandOverlay.addEventListener('click', (e) => {
              e.preventDefault();
              e.stopPropagation();
              openVideoLightbox(video.src || video.querySelector('source')?.src, video);
            });
          } else {
            // No expand overlay, video itself triggers lightbox
            video.style.cursor = 'pointer';
            video.addEventListener('click', (e) => {
              e.preventDefault();
              openVideoLightbox(video.src || video.querySelector('source')?.src, video);
            });
          }
          
          // Hide/show play overlay based on video state if it exists
          const overlay = container ? container.querySelector('.play-overlay') : null;
          
          if (overlay) {
            video.addEventListener('play', () => overlay.style.display = 'none');
            video.addEventListener('pause', () => overlay.style.display = 'block');
          }
        });

        lightbox.addEventListener('click', (e) => {
          if (e.target === lightbox) closeLightbox();
        });
        lightboxClose.addEventListener('click', () => closeLightbox());

        // Prevent closing when clicking the media itself
        lightboxImg.addEventListener('click', (e) => e.stopPropagation());
        lightboxVideo.addEventListener('click', (e) => e.stopPropagation());

        // Close on Escape key
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && lightbox.classList.contains('active')) {
            closeLightbox();
          }
        });

        // Sound toggle for inline videos
        contentContainer.querySelectorAll('.video-container').forEach(container => {
          const video = container.querySelector('video');
          const soundBtn = container.querySelector('.sound-toggle');
          
          if (video && soundBtn) {
            soundBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              video.muted = !video.muted;
              soundBtn.classList.toggle('unmuted', !video.muted);
              soundBtn.innerHTML = video.muted 
                ? '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 5L6 9H2v6h4l5 4V5z"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/></svg>'
                : '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>';
            });
          }
        });
      }
    });
  </script>

</body>

</html>
